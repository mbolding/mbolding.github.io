<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cerebellar Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #ffffff;
            --secondary-text: #888888;
            --accent-color: #ff3300;
            --card-bg: #1a1a1a;
            --granule-color: #4a90e2;
            --purkinje-color: #e24a4a;
            --climbing-fiber: #ffaa00;
            --mossy-fiber: #00ff88;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            border-bottom: 3px solid var(--accent-color);
            padding-bottom: 15px;
        }

        h1 {
            font-size: 48px;
            font-weight: 800;
            margin: 0 0 10px 0;
            letter-spacing: -1.5px;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 18px;
            font-weight: 300;
            color: var(--secondary-text);
            margin: 0;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .canvas-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 4px;
            position: relative;
        }

        canvas {
            display: block;
            width: 100%;
            background-color: #000000;
            border: 2px solid #333;
        }

        .controls-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 4px;
            height: fit-content;
        }

        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .control-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .control-section h3 {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--secondary-text);
            margin: 0 0 15px 0;
            font-weight: 600;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            background-color: #333;
            color: var(--text-color);
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            background-color: #444;
        }

        button.active {
            background-color: var(--accent-color);
            color: #ffffff;
        }

        button.full-width {
            grid-column: 1 / -1;
        }

        .slider-control {
            margin-bottom: 15px;
        }

        .slider-control label {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            color: var(--secondary-text);
        }

        .slider-value {
            float: right;
            color: var(--accent-color);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 4px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            cursor: pointer;
            border: none;
        }

        .sparklines-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .sparklines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .sparkline-container {
            position: relative;
        }

        .sparkline-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--secondary-text);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }

        .sparkline-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-color);
        }

        .sparkline-canvas {
            width: 100%;
            height: 50px;
            display: block;
            background-color: #000000;
            border: 1px solid #222;
        }

        .sparkline-range {
            font-size: 9px;
            color: #555;
            margin-top: 4px;
            display: flex;
            justify-content: space-between;
        }

        .info-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--secondary-text);
            margin-top: 10px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 11px;
            color: var(--secondary-text);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 6px;
            border-radius: 2px;
        }

        .hypothesis-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .hypothesis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .hypothesis-card {
            background-color: #000;
            padding: 15px;
            border-left: 3px solid var(--accent-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .hypothesis-card:hover {
            background-color: #111;
        }

        .hypothesis-card.active {
            background-color: #1a1a1a;
            border-left-color: var(--climbing-fiber);
        }

        .hypothesis-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .hypothesis-description {
            font-size: 11px;
            color: var(--secondary-text);
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 32px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .sparklines-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Cerebellar Cortex</h1>
            <p class="subtitle">Numerical simulation of error-based motor learning and timing prediction</p>
        </header>

        <div class="hypothesis-panel">
            <div class="control-section">
                <h3>Test Hypotheses</h3>
                <div class="hypothesis-grid">
                    <div class="hypothesis-card active" data-hypothesis="timing">
                        <div class="hypothesis-title">Motor Timing</div>
                        <div class="hypothesis-description">Learn precise temporal patterns via climbing fiber error signals</div>
                    </div>
                    <div class="hypothesis-card" data-hypothesis="adaptation">
                        <div class="hypothesis-title">Adaptive Control</div>
                        <div class="hypothesis-description">Adjust motor commands based on sensory prediction errors</div>
                    </div>
                    <div class="hypothesis-card" data-hypothesis="ltd">
                        <div class="hypothesis-title">LTD Mechanism</div>
                        <div class="hypothesis-description">Parallel fiber-Purkinje LTD when climbing fibers signal error</div>
                    </div>
                    <div class="hypothesis-card" data-hypothesis="pattern">
                        <div class="hypothesis-title">Pattern Separation</div>
                        <div class="hypothesis-description">Granule cells expand sparse coding for discrimination</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="canvas-container">
                <canvas id="cerebellumCanvas" width="800" height="600"></canvas>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--granule-color);"></div>
                        <span>Granule Cells</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--purkinje-color);"></div>
                        <span>Purkinje Cells</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--mossy-fiber);"></div>
                        <span>Mossy Fibers</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: var(--climbing-fiber);"></div>
                        <span>Climbing Fibers</span>
                    </div>
                </div>
            </div>

            <div class="controls-panel">
                <div class="control-section">
                    <h3>Simulation Control</h3>
                    <div class="button-group">
                        <button id="playPauseBtn" class="full-width">Pause</button>
                        <button id="resetBtn" class="full-width">Reset</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Input Signals</h3>
                    <div class="button-group">
                        <button id="mossyFiberBtn">Mossy Input</button>
                        <button id="climbingFiberBtn">Error Signal</button>
                        <button id="patternBtn" class="full-width">Timed Pattern</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Learning Parameters</h3>
                    <div class="slider-control">
                        <label>
                            LTD Rate
                            <span class="slider-value" id="ltdRateValue">0.05</span>
                        </label>
                        <input type="range" id="ltdRate" min="0" max="0.2" step="0.01" value="0.05">
                    </div>
                    <div class="slider-control">
                        <label>
                            LTP Rate
                            <span class="slider-value" id="ltpRateValue">0.02</span>
                        </label>
                        <input type="range" id="ltpRate" min="0" max="0.1" step="0.01" value="0.02">
                    </div>
                    <div class="slider-control">
                        <label>
                            Baseline Weight
                            <span class="slider-value" id="baselineValue">0.5</span>
                        </label>
                        <input type="range" id="baseline" min="0.1" max="0.9" step="0.05" value="0.5">
                    </div>
                </div>

                <div class="control-section">
                    <h3>Network Parameters</h3>
                    <div class="slider-control">
                        <label>
                            Purkinje Threshold
                            <span class="slider-value" id="thresholdValue">2.0</span>
                        </label>
                        <input type="range" id="threshold" min="0.5" max="5.0" step="0.1" value="2.0">
                    </div>
                    <div class="slider-control">
                        <label>
                            Temporal Window (ms)
                            <span class="slider-value" id="windowValue">100</span>
                        </label>
                        <input type="range" id="window" min="50" max="300" step="10" value="100">
                    </div>
                </div>
            </div>
        </div>

        <div class="sparklines-panel">
            <div class="sparklines-grid">
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Purkinje Activity</span>
                        <span class="sparkline-value" id="purkinjeValue">0</span>
                    </div>
                    <canvas id="purkinjeSparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="purkinjeMin">0</span>
                        <span id="purkinjeMax">8</span>
                    </div>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Granule Activity</span>
                        <span class="sparkline-value" id="granuleValue">0</span>
                    </div>
                    <canvas id="granuleSparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="granuleMin">0</span>
                        <span id="granuleMax">40</span>
                    </div>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Parallel Fiber Weights</span>
                        <span class="sparkline-value" id="weightValue">0.50</span>
                    </div>
                    <canvas id="weightSparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="weightMin">0.0</span>
                        <span id="weightMax">1.0</span>
                    </div>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Climbing Fiber Errors</span>
                        <span class="sparkline-value" id="errorValue">0</span>
                    </div>
                    <canvas id="errorSparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="errorMin">0</span>
                        <span id="errorMax">8</span>
                    </div>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Deep Nuclei Output</span>
                        <span class="sparkline-value" id="outputValue">0.0</span>
                    </div>
                    <canvas id="outputSparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="outputMin">0.0</span>
                        <span id="outputMax">1.0</span>
                    </div>
                </div>
                <div class="sparkline-container">
                    <div class="sparkline-label">
                        <span>Prediction Accuracy</span>
                        <span class="sparkline-value" id="accuracyValue">0%</span>
                    </div>
                    <canvas id="accuracySparkline" class="sparkline-canvas" width="600" height="50"></canvas>
                    <div class="sparkline-range">
                        <span id="accuracyMin">0%</span>
                        <span id="accuracyMax">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cerebellar Simulation Model

        class GranuleCell {
            constructor(x, y, id) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.activity = 0;
                this.threshold = 0.3;
                this.decayRate = 0.85;
            }

            update(mossyInput) {
                this.activity += mossyInput;
                if (this.activity > this.threshold) {
                    this.activity = 1.0;
                } else {
                    this.activity *= this.decayRate;
                }
            }

            isActive() {
                return this.activity > this.threshold;
            }
        }

        class PurkinjeCell {
            constructor(x, y, id) {
                this.x = x;
                this.y = y;
                this.id = id;
                this.activity = 0;
                this.parallelFiberInput = 0;
                this.climbingFiberInput = 0;
                this.threshold = 2.0;
                this.decayRate = 0.8;
                this.complexSpike = false;
            }

            update(threshold) {
                this.threshold = threshold;

                // Climbing fiber causes complex spike (overrides everything)
                if (this.climbingFiberInput > 0.5) {
                    this.complexSpike = true;
                    this.activity = 3.0;
                } else {
                    this.complexSpike = false;
                    this.activity = this.parallelFiberInput;
                }

                // Simple spike if threshold exceeded
                if (this.activity > this.threshold && !this.complexSpike) {
                    this.activity = 1.0;
                } else if (!this.complexSpike) {
                    this.activity *= this.decayRate;
                }

                // Reset inputs
                this.parallelFiberInput = 0;
                this.climbingFiberInput = 0;
            }

            receiveParallelFiberInput(input) {
                this.parallelFiberInput += input;
            }

            receiveClimbingFiberInput(input) {
                this.climbingFiberInput = input;
            }

            isActive() {
                return this.activity > 0.5;
            }
        }

        class ParallelFiberSynapse {
            constructor(granule, purkinje) {
                this.granule = granule;
                this.purkinje = purkinje;
                this.weight = 0.5;
                this.minWeight = 0.01;
                this.maxWeight = 1.0;
                this.eligibilityTrace = 0;
            }

            transmit() {
                if (this.granule.isActive()) {
                    this.purkinje.receiveParallelFiberInput(this.weight);
                    this.eligibilityTrace = 1.0; // Mark for potential plasticity
                }
            }

            updateWeight(ltdRate, ltpRate, baseline) {
                // Marr-Albus model: LTD when climbing fiber active and parallel fiber active
                if (this.eligibilityTrace > 0.5 && this.purkinje.complexSpike) {
                    // LTD: weaken synapse
                    this.weight -= ltdRate * this.weight;
                } else if (this.eligibilityTrace > 0.5 && !this.purkinje.complexSpike) {
                    // LTP: strengthen synapse (weak)
                    this.weight += ltpRate * (this.maxWeight - this.weight);
                }

                // Slow drift toward baseline
                this.weight += (baseline - this.weight) * 0.001;

                // Clamp
                this.weight = Math.max(this.minWeight, Math.min(this.maxWeight, this.weight));

                // Decay eligibility trace
                this.eligibilityTrace *= 0.7;
            }
        }

        class CerebellarCortex {
            constructor() {
                this.granuleCells = [];
                this.purkinjeCells = [];
                this.parallelFiberSynapses = [];
                this.timeStep = 0;
                this.climbingFiberErrors = [];

                // Create granule cells (many, sparse coding)
                const numGranule = 40;
                for (let i = 0; i < numGranule; i++) {
                    const x = 50 + (i % 10) * 70;
                    const y = 450 + Math.floor(i / 10) * 35;
                    this.granuleCells.push(new GranuleCell(x, y, i));
                }

                // Create Purkinje cells (fewer, integrate many parallel fibers)
                const numPurkinje = 8;
                for (let i = 0; i < numPurkinje; i++) {
                    const x = 100 + i * 90;
                    const y = 250;
                    this.purkinjeCells.push(new PurkinjeCell(x, y, i));
                }

                // Connect parallel fibers to Purkinje cells (divergent-convergent)
                for (let g of this.granuleCells) {
                    for (let p of this.purkinjeCells) {
                        // Each granule connects to multiple Purkinje cells
                        if (Math.random() < 0.6) {
                            this.parallelFiberSynapses.push(new ParallelFiberSynapse(g, p));
                        }
                    }
                }
            }

            provideMossyFiberInput(pattern = null) {
                // Mossy fibers activate granule cells
                if (pattern) {
                    pattern.forEach(idx => {
                        if (idx < this.granuleCells.length) {
                            this.granuleCells[idx].activity = 1.0;
                        }
                    });
                } else {
                    // Random sparse input
                    this.granuleCells.forEach(gc => {
                        if (Math.random() < 0.15) {
                            gc.activity = Math.random() * 0.5 + 0.5;
                        }
                    });
                }
            }

            provideClimbingFiberInput(purkinjeIndices) {
                // Climbing fibers signal errors to specific Purkinje cells
                purkinjeIndices.forEach(idx => {
                    if (idx < this.purkinjeCells.length) {
                        this.purkinjeCells[idx].receiveClimbingFiberInput(1.0);
                        this.climbingFiberErrors.push(this.timeStep);
                    }
                });
            }

            update(threshold, ltdRate, ltpRate, baseline) {
                this.timeStep++;

                // Update granule cells
                this.granuleCells.forEach(gc => gc.update(0));

                // Transmit through parallel fibers
                this.parallelFiberSynapses.forEach(pfs => pfs.transmit());

                // Update Purkinje cells
                this.purkinjeCells.forEach(pc => pc.update(threshold));

                // Update synaptic weights (plasticity)
                this.parallelFiberSynapses.forEach(pfs =>
                    pfs.updateWeight(ltdRate, ltpRate, baseline)
                );

                // Clean old error markers
                this.climbingFiberErrors = this.climbingFiberErrors.filter(
                    t => this.timeStep - t < 30
                );
            }

            getActivePurkinjeCells() {
                return this.purkinjeCells.filter(pc => pc.isActive()).length;
            }

            getActiveGranuleCells() {
                return this.granuleCells.filter(gc => gc.isActive()).length;
            }

            getAverageWeight() {
                if (this.parallelFiberSynapses.length === 0) return 0;
                const sum = this.parallelFiberSynapses.reduce((acc, pfs) => acc + pfs.weight, 0);
                return sum / this.parallelFiberSynapses.length;
            }

            getDeepNucleiOutput() {
                // Deep cerebellar nuclei receive inhibition from Purkinje cells
                // More active Purkinje cells = less output
                const purkinjeActivity = this.purkinjeCells.reduce((sum, pc) => sum + pc.activity, 0);
                const maxActivity = this.purkinjeCells.length * 3.0;
                return Math.max(0, 1.0 - (purkinjeActivity / maxActivity));
            }

            reset() {
                this.timeStep = 0;
                this.climbingFiberErrors = [];
                this.granuleCells.forEach(gc => gc.activity = 0);
                this.purkinjeCells.forEach(pc => {
                    pc.activity = 0;
                    pc.parallelFiberInput = 0;
                    pc.climbingFiberInput = 0;
                    pc.complexSpike = false;
                });
                this.parallelFiberSynapses.forEach(pfs => pfs.weight = 0.5);
            }
        }

        // Sparkline Visualization (Tufte style)
        class Sparkline {
            constructor(canvas, maxDataPoints = 300, minValue = 0, maxValue = 1, color = '#ff3300') {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.data = [];
                this.maxDataPoints = maxDataPoints;
                this.minValue = minValue;
                this.maxValue = maxValue;
                this.color = color;
            }

            addData(value) {
                this.data.push(value);
                if (this.data.length > this.maxDataPoints) {
                    this.data.shift();
                }
            }

            clear() {
                this.data = [];
            }

            draw() {
                const ctx = this.ctx;
                const width = this.canvas.width;
                const height = this.canvas.height;

                ctx.clearRect(0, 0, width, height);

                if (this.data.length < 2) return;

                const range = this.maxValue - this.minValue || 1;

                // Reference line at midpoint
                ctx.strokeStyle = '#222';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.stroke();

                // Filled area
                ctx.fillStyle = this.color + '15';
                ctx.beginPath();
                ctx.moveTo(0, height);

                for (let i = 0; i < this.data.length; i++) {
                    const x = (i / (this.maxDataPoints - 1)) * width;
                    const y = height - ((this.data[i] - this.minValue) / range) * height;
                    if (i === 0) ctx.lineTo(x, y);
                    else ctx.lineTo(x, y);
                }

                ctx.lineTo(((this.data.length - 1) / (this.maxDataPoints - 1)) * width, height);
                ctx.closePath();
                ctx.fill();

                // Line
                ctx.strokeStyle = this.color;
                ctx.lineWidth = 1.5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();

                for (let i = 0; i < this.data.length; i++) {
                    const x = (i / (this.maxDataPoints - 1)) * width;
                    const y = height - ((this.data[i] - this.minValue) / range) * height;

                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }

                ctx.stroke();

                // Endpoint dot
                if (this.data.length > 0) {
                    const lastIdx = this.data.length - 1;
                    const lastX = (lastIdx / (this.maxDataPoints - 1)) * width;
                    const lastY = height - ((this.data[lastIdx] - this.minValue) / range) * height;

                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(lastX, lastY, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            getCurrentValue() {
                return this.data.length > 0 ? this.data[this.data.length - 1] : 0;
            }
        }

        // Visualization
        class CerebellarVisualizer {
            constructor(canvas, cortex) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.cortex = cortex;
            }

            draw() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Draw parallel fiber synapses (faint connections)
                this.cortex.parallelFiberSynapses.forEach(pfs => {
                    const alpha = pfs.weight * 0.2;
                    ctx.strokeStyle = `rgba(74, 144, 226, ${alpha})`;
                    ctx.lineWidth = pfs.weight * 1.5;
                    ctx.beginPath();
                    ctx.moveTo(pfs.granule.x, pfs.granule.y);
                    ctx.lineTo(pfs.purkinje.x, pfs.purkinje.y);
                    ctx.stroke();
                });

                // Draw climbing fiber error signals
                this.cortex.climbingFiberErrors.forEach(errorTime => {
                    const age = this.cortex.timeStep - errorTime;
                    const alpha = Math.max(0, 1 - age / 30);

                    this.cortex.purkinjeCells.forEach(pc => {
                        if (pc.complexSpike) {
                            ctx.strokeStyle = `rgba(255, 170, 0, ${alpha})`;
                            ctx.lineWidth = 3;
                            ctx.beginPath();
                            ctx.moveTo(pc.x, 50);
                            ctx.lineTo(pc.x, pc.y);
                            ctx.stroke();
                        }
                    });
                });

                // Draw granule cells
                this.cortex.granuleCells.forEach(gc => {
                    const radius = 4;

                    if (gc.isActive()) {
                        ctx.fillStyle = 'rgba(74, 144, 226, 0.3)';
                        ctx.beginPath();
                        ctx.arc(gc.x, gc.y, radius + 4, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = '#4a90e2';
                    } else {
                        ctx.fillStyle = 'rgba(74, 144, 226, 0.2)';
                    }

                    ctx.beginPath();
                    ctx.arc(gc.x, gc.y, radius, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Draw Purkinje cells
                this.cortex.purkinjeCells.forEach(pc => {
                    const radius = 18;

                    // Draw dendritic tree (schematic)
                    ctx.strokeStyle = 'rgba(226, 74, 74, 0.3)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(pc.x, pc.y);
                    ctx.lineTo(pc.x - 20, pc.y + 40);
                    ctx.moveTo(pc.x, pc.y);
                    ctx.lineTo(pc.x, pc.y + 40);
                    ctx.moveTo(pc.x, pc.y);
                    ctx.lineTo(pc.x + 20, pc.y + 40);
                    ctx.stroke();

                    // Glow if active
                    if (pc.isActive()) {
                        ctx.fillStyle = pc.complexSpike ?
                            'rgba(255, 170, 0, 0.4)' : 'rgba(226, 74, 74, 0.4)';
                        ctx.beginPath();
                        ctx.arc(pc.x, pc.y, radius + 8, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Cell body
                    if (pc.complexSpike) {
                        ctx.fillStyle = '#ffaa00';
                    } else if (pc.isActive()) {
                        ctx.fillStyle = '#e24a4a';
                    } else {
                        ctx.fillStyle = 'rgba(226, 74, 74, 0.3)';
                    }

                    ctx.beginPath();
                    ctx.arc(pc.x, pc.y, radius, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.strokeStyle = pc.isActive() ? '#ffffff' : '#555555';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Label
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 11px Inter';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`P${pc.id}`, pc.x, pc.y);
                });

                // Draw layer labels
                ctx.fillStyle = '#555';
                ctx.font = '11px Inter';
                ctx.textAlign = 'left';
                ctx.fillText('CLIMBING FIBERS', 10, 30);
                ctx.fillText('PURKINJE LAYER', 10, 240);
                ctx.fillText('GRANULE LAYER', 10, 440);
            }
        }

        // Hypothesis testing scenarios
        class HypothesisTester {
            constructor(cortex) {
                this.cortex = cortex;
                this.currentHypothesis = 'timing';
                this.stepCounter = 0;
                this.patternMemory = [];
                this.correctPredictions = 0;
                this.totalTests = 0;
            }

            setHypothesis(hypothesis) {
                this.currentHypothesis = hypothesis;
                this.stepCounter = 0;
                this.patternMemory = [];
                this.correctPredictions = 0;
                this.totalTests = 0;
            }

            step() {
                this.stepCounter++;

                switch (this.currentHypothesis) {
                    case 'timing':
                        this.testMotorTiming();
                        break;
                    case 'adaptation':
                        this.testAdaptiveControl();
                        break;
                    case 'ltd':
                        this.testLTDMechanism();
                        break;
                    case 'pattern':
                        this.testPatternSeparation();
                        break;
                }
            }

            testMotorTiming() {
                // Test temporal prediction: pattern every 50 steps
                if (this.stepCounter % 50 === 0) {
                    this.cortex.provideMossyFiberInput([0, 5, 10, 15]);

                    // Check if Purkinje cells predicted it (should have low activity if learned)
                    const purkinjeActivity = this.cortex.getActivePurkinjeCells();
                    if (purkinjeActivity < 3) {
                        this.correctPredictions++;
                    }
                    this.totalTests++;
                }

                // Occasionally provide error signal if prediction was wrong
                if (this.stepCounter % 50 === 0 && Math.random() < 0.3) {
                    this.cortex.provideClimbingFiberInput([0, 1, 2]);
                }
            }

            testAdaptiveControl() {
                // Test adaptation to changing input patterns
                const cycle = this.stepCounter % 100;

                if (cycle === 0) {
                    // Target pattern
                    this.cortex.provideMossyFiberInput([2, 7, 12, 17]);
                } else if (cycle === 50) {
                    // Different pattern
                    this.cortex.provideMossyFiberInput([3, 8, 13, 18]);
                }

                // Error signal when output doesn't match expected
                if (cycle === 10 || cycle === 60) {
                    const output = this.cortex.getDeepNucleiOutput();
                    if (output > 0.3) {
                        this.cortex.provideClimbingFiberInput([1, 3, 5]);
                    }
                }
            }

            testLTDMechanism() {
                // Explicitly test LTD: activate specific parallel fibers with error signal
                if (this.stepCounter % 30 === 0) {
                    this.cortex.provideMossyFiberInput([0, 1, 2, 3, 4]);
                    this.cortex.provideClimbingFiberInput([0, 1]); // Should cause LTD
                    this.totalTests++;
                }

                if (this.stepCounter % 30 === 15) {
                    this.cortex.provideMossyFiberInput([10, 11, 12, 13, 14]);
                    // No error signal - should cause LTP
                }
            }

            testPatternSeparation() {
                // Test ability to discriminate similar patterns
                const patterns = [
                    [0, 1, 2, 3],
                    [1, 2, 3, 4],
                    [20, 21, 22, 23],
                ];

                const patternIdx = Math.floor(this.stepCounter / 20) % patterns.length;

                if (this.stepCounter % 20 === 0) {
                    this.cortex.provideMossyFiberInput(patterns[patternIdx]);

                    // Error for pattern 1 only
                    if (patternIdx === 1) {
                        this.cortex.provideClimbingFiberInput([2, 3, 4]);
                    }
                }
            }

            getAccuracy() {
                if (this.totalTests === 0) return 0;
                return (this.correctPredictions / this.totalTests) * 100;
            }
        }

        // Application State
        const cortex = new CerebellarCortex();
        const canvas = document.getElementById('cerebellumCanvas');
        const visualizer = new CerebellarVisualizer(canvas, cortex);
        const hypothesisTester = new HypothesisTester(cortex);

        // Initialize sparklines
        const purkinjeSparkline = new Sparkline(
            document.getElementById('purkinjeSparkline'),
            300, 0, 8, '#e24a4a'
        );
        const granuleSparkline = new Sparkline(
            document.getElementById('granuleSparkline'),
            300, 0, 40, '#4a90e2'
        );
        const weightSparkline = new Sparkline(
            document.getElementById('weightSparkline'),
            300, 0, 1.0, '#ff3300'
        );
        const errorSparkline = new Sparkline(
            document.getElementById('errorSparkline'),
            300, 0, 8, '#ffaa00'
        );
        const outputSparkline = new Sparkline(
            document.getElementById('outputSparkline'),
            300, 0, 1.0, '#00ff88'
        );
        const accuracySparkline = new Sparkline(
            document.getElementById('accuracySparkline'),
            300, 0, 100, '#00ddff'
        );

        let isRunning = true;
        let ltdRate = 0.05;
        let ltpRate = 0.02;
        let baseline = 0.5;
        let threshold = 2.0;
        let temporalWindow = 100;

        // UI Elements
        const playPauseBtn = document.getElementById('playPauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const mossyFiberBtn = document.getElementById('mossyFiberBtn');
        const climbingFiberBtn = document.getElementById('climbingFiberBtn');
        const patternBtn = document.getElementById('patternBtn');

        // Sliders
        const ltdRateSlider = document.getElementById('ltdRate');
        const ltpRateSlider = document.getElementById('ltpRate');
        const baselineSlider = document.getElementById('baseline');
        const thresholdSlider = document.getElementById('threshold');
        const windowSlider = document.getElementById('window');

        // Hypothesis cards
        const hypothesisCards = document.querySelectorAll('.hypothesis-card');

        // Event Listeners
        playPauseBtn.addEventListener('click', () => {
            isRunning = !isRunning;
            playPauseBtn.textContent = isRunning ? 'Pause' : 'Play';
        });

        resetBtn.addEventListener('click', () => {
            cortex.reset();
            hypothesisTester.stepCounter = 0;
            hypothesisTester.correctPredictions = 0;
            hypothesisTester.totalTests = 0;
            purkinjeSparkline.clear();
            granuleSparkline.clear();
            weightSparkline.clear();
            errorSparkline.clear();
            outputSparkline.clear();
            accuracySparkline.clear();
        });

        mossyFiberBtn.addEventListener('click', () => {
            cortex.provideMossyFiberInput();
        });

        climbingFiberBtn.addEventListener('click', () => {
            const randomPurkinje = [Math.floor(Math.random() * cortex.purkinjeCells.length)];
            cortex.provideClimbingFiberInput(randomPurkinje);
        });

        patternBtn.addEventListener('click', () => {
            cortex.provideMossyFiberInput([0, 5, 10, 15, 20]);
        });

        ltdRateSlider.addEventListener('input', (e) => {
            ltdRate = parseFloat(e.target.value);
            document.getElementById('ltdRateValue').textContent = ltdRate.toFixed(2);
        });

        ltpRateSlider.addEventListener('input', (e) => {
            ltpRate = parseFloat(e.target.value);
            document.getElementById('ltpRateValue').textContent = ltpRate.toFixed(2);
        });

        baselineSlider.addEventListener('input', (e) => {
            baseline = parseFloat(e.target.value);
            document.getElementById('baselineValue').textContent = baseline.toFixed(2);
        });

        thresholdSlider.addEventListener('input', (e) => {
            threshold = parseFloat(e.target.value);
            document.getElementById('thresholdValue').textContent = threshold.toFixed(1);
        });

        windowSlider.addEventListener('input', (e) => {
            temporalWindow = parseInt(e.target.value);
            document.getElementById('windowValue').textContent = temporalWindow;
        });

        hypothesisCards.forEach(card => {
            card.addEventListener('click', () => {
                hypothesisCards.forEach(c => c.classList.remove('active'));
                card.classList.add('active');
                const hypothesis = card.getAttribute('data-hypothesis');
                hypothesisTester.setHypothesis(hypothesis);
                cortex.reset();
                purkinjeSparkline.clear();
                granuleSparkline.clear();
                weightSparkline.clear();
                errorSparkline.clear();
                outputSparkline.clear();
                accuracySparkline.clear();
            });
        });

        // Animation Loop
        function animate() {
            if (isRunning) {
                // Run hypothesis test
                hypothesisTester.step();

                // Update cortex
                cortex.update(threshold, ltdRate, ltpRate, baseline);

                // Update sparklines
                const purkinjeActivity = cortex.getActivePurkinjeCells();
                const granuleActivity = cortex.getActiveGranuleCells();
                const avgWeight = cortex.getAverageWeight();
                const climbingFiberActivity = cortex.purkinjeCells.filter(pc => pc.complexSpike).length;
                const deepNucleiOutput = cortex.getDeepNucleiOutput();
                const accuracy = hypothesisTester.getAccuracy();

                purkinjeSparkline.addData(purkinjeActivity);
                granuleSparkline.addData(granuleActivity);
                weightSparkline.addData(avgWeight);
                errorSparkline.addData(climbingFiberActivity);
                outputSparkline.addData(deepNucleiOutput);
                accuracySparkline.addData(accuracy);

                // Update value displays
                document.getElementById('purkinjeValue').textContent = purkinjeActivity;
                document.getElementById('granuleValue').textContent = granuleActivity;
                document.getElementById('weightValue').textContent = avgWeight.toFixed(3);
                document.getElementById('errorValue').textContent = climbingFiberActivity;
                document.getElementById('outputValue').textContent = deepNucleiOutput.toFixed(2);
                document.getElementById('accuracyValue').textContent = accuracy.toFixed(0) + '%';
            }

            // Draw visualizations
            visualizer.draw();
            purkinjeSparkline.draw();
            granuleSparkline.draw();
            weightSparkline.draw();
            errorSparkline.draw();
            outputSparkline.draw();
            accuracySparkline.draw();

            requestAnimationFrame(animate);
        }

        // Start animation
        animate();
    </script>
</body>
</html>
