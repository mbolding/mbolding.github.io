<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python REPL</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.27.0/full/pyodide.js"></script>
    <style>
        :root {
            --bg: #1e1e1e;
            --fg: #d4d4d4;
            --prompt: #569cd6;
            --output: #6a9955;
            --error: #f44747;
            --input-bg: #252526;
            --border: #3c3c3c;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #status {
            padding: 8px 16px;
            background: var(--input-bg);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: #888;
        }

        #status.ready {
            color: var(--output);
        }

        #output {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .line {
            margin-bottom: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .input-line {
            color: var(--fg);
        }

        .input-line::before {
            content: ">>> ";
            color: var(--prompt);
        }

        .output-line {
            color: var(--output);
            padding-left: 2em;
        }

        .error-line {
            color: var(--error);
            padding-left: 2em;
        }

        #input-area {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--input-bg);
            border-top: 1px solid var(--border);
        }

        #prompt-symbol {
            color: var(--prompt);
            margin-right: 8px;
        }

        #input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--fg);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        #input::placeholder {
            color: #666;
        }

        #input:disabled {
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="status">Loading Python...</div>
    <div id="output"></div>
    <div id="input-area">
        <span id="prompt-symbol">&gt;&gt;&gt;</span>
        <input type="text" id="input" placeholder="Enter Python code..." disabled autocomplete="off">
    </div>

    <script>
        let pyodide = null;
        let history = [];
        let historyIndex = -1;

        const status = document.getElementById('status');
        const output = document.getElementById('output');
        const inputEl = document.getElementById('input');

        function log(text, className = 'output-line') {
            const div = document.createElement('div');
            div.className = 'line ' + className;
            div.textContent = text;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        function logImage(base64) {
            const div = document.createElement('div');
            div.className = 'line';
            const img = document.createElement('img');
            img.src = 'data:image/png;base64,' + base64;
            img.style.maxWidth = '100%';
            div.appendChild(img);
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }

        async function init() {
            try {
                status.textContent = 'Loading Python runtime...';
                pyodide = await loadPyodide();

                status.textContent = 'Loading numpy...';
                await pyodide.loadPackage('numpy');

                status.textContent = 'Loading scipy...';
                await pyodide.loadPackage('scipy');

                status.textContent = 'Loading sympy...';
                await pyodide.loadPackage('sympy');

                status.textContent = 'Loading matplotlib...';
                await pyodide.loadPackage('matplotlib');

                await pyodide.runPythonAsync(`
import sys
import numpy as np
import scipy
from math import factorial, gcd, lcm, comb, perm, isclose, isinf, isnan
import sympy as sp
from sympy import *
import matplotlib
matplotlib.use('AGG')
import matplotlib.pyplot as plt
import io, base64

x, y, z, t, n, k = symbols('x y z t n k')

def show_plot():
    buf = io.BytesIO()
    plt.savefig(buf, format='png', bbox_inches='tight', facecolor='#1e1e1e', edgecolor='none')
    buf.seek(0)
    img = base64.b64encode(buf.read()).decode()
    plt.close()
    return '__IMG__' + img

def test():
    """Run all examples and display results."""
    tests = [
        # Basic math
        ("2 + 2", "4"),
        ("sqrt(2)", None),
        ("sin(pi/4)", None),
        ("factorial(10)", "3628800"),

        # NumPy
        ("np.array([1, 2, 3])", None),
        ("np.linspace(0, 10, 5)", None),
        ("np.linalg.det([[1,2],[3,4]])", None),

        # SymPy
        ("expand((x + 1)**3)", "x**3 + 3*x**2 + 3*x + 1"),
        ("factor(x**2 - 4)", "(x - 2)*(x + 2)"),
        ("simplify(sin(x)**2 + cos(x)**2)", "1"),
        ("solve(x**2 - 4, x)", "[-2, 2]"),
        ("diff(x**3, x)", "3*x**2"),
        ("integrate(x**2, x)", "x**3/3"),
        ("limit(sin(x)/x, x, 0)", "1"),
    ]

    print("Running tests...\\n")
    passed = 0
    failed = 0

    for expr, expected in tests:
        try:
            result = eval(expr)
            result_str = str(result)
            if expected is None:
                status = "OK"
                passed += 1
            elif result_str == expected:
                status = "OK"
                passed += 1
            else:
                status = f"FAIL (expected {expected})"
                failed += 1
            print(f"  {expr}")
            print(f"    => {result_str}  [{status}]")
        except Exception as e:
            print(f"  {expr}")
            print(f"    => ERROR: {e}")
            failed += 1

    print(f"\\n{passed} passed, {failed} failed")

def help():
    print("""
PYTHON REPL - Quick Reference
==============================

LIBRARIES LOADED:
  np        - NumPy (arrays, linear algebra)
  sp/sympy  - SymPy (symbolic math, sin, cos, sqrt, pi, etc.)
  scipy     - SciPy (scientific computing)
  plt       - Matplotlib (plotting)

SYMBOLIC VARIABLES (predefined):
  x, y, z, t, n, k

COMMANDS:
  help()    - Show this reference
  test()    - Run all examples to verify everything works

KEYBOARD:
  Enter     - Execute code
  Up/Down   - Command history
  Ctrl+L    - Clear output

EXAMPLES:

  Basic math:
    2 + 2
    sqrt(2)
    sin(pi/4)
    factorial(10)

  NumPy:
    np.array([1, 2, 3])
    np.linspace(0, 10, 5)
    np.random.rand(3, 3)
    np.linalg.det([[1,2],[3,4]])

  SymPy (symbolic):
    expand((x + 1)**3)
    factor(x**2 - 4)
    simplify(sin(x)**2 + cos(x)**2)
    solve(x**2 - 4, x)
    diff(x**3, x)
    integrate(x**2, x)
    limit(sin(x)/x, x, 0)
    series(exp(x), x, 0, 5)

  Plotting:
    plt.plot([1,2,3], [1,4,9]); show_plot()
    x_vals = np.linspace(0, 2*np.pi, 100)
    plt.plot(x_vals, np.sin(x_vals)); show_plot()
""")
`);

                const version = pyodide.runPython('sys.version.split()[0]');
                status.textContent = 'Python ' + version + ' ready - numpy, scipy, sympy, matplotlib';
                status.className = 'ready';

                inputEl.disabled = false;
                inputEl.focus();

                log('Python REPL with math libraries');
                log('Type help() for reference and examples');
                log('');
                log('Try: 2+2, sqrt(2), solve(x**2-4,x), diff(x**3,x)');
                log('');

            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                console.error(err);
            }
        }

        async function execute(code) {
            log(code, 'input-line');
            history.push(code);
            historyIndex = history.length;

            try {
                // Use Python to handle eval vs exec and capture output
                pyodide.globals.set('_user_code_', code);

                const resultProxy = await pyodide.runPythonAsync(`
import sys
from io import StringIO

_captured_ = StringIO()
_old_stdout_ = sys.stdout
sys.stdout = _captured_

_exec_result_ = None
try:
    try:
        _exec_result_ = eval(_user_code_)
    except SyntaxError:
        exec(_user_code_)
        _exec_result_ = None
finally:
    sys.stdout = _old_stdout_

_output_text_ = _captured_.getvalue()
_final_ = []
if _output_text_:
    _final_.append(_output_text_.rstrip())
if _exec_result_ is not None:
    _final_.append(repr(_exec_result_))
'\\n'.join(_final_) if _final_ else None
`);

                if (resultProxy !== null && resultProxy !== undefined) {
                    const result = String(resultProxy);
                    if (result.startsWith('__IMG__')) {
                        logImage(result.slice(7));
                    } else if (result) {
                        result.split('\n').forEach(line => log(line));
                    }
                }

            } catch (err) {
                const msg = err.message || String(err);
                // Extract just the last line of Python errors for cleaner display
                const lines = msg.split('\n').filter(l => l.trim());
                const lastLine = lines[lines.length - 1] || msg;
                log(lastLine, 'error-line');
            }
        }

        inputEl.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const code = inputEl.value.trim();
                if (code) {
                    inputEl.value = '';
                    await execute(code);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    inputEl.value = history[historyIndex];
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    inputEl.value = history[historyIndex];
                } else {
                    historyIndex = history.length;
                    inputEl.value = '';
                }
            } else if (e.key === 'l' && e.ctrlKey) {
                e.preventDefault();
                output.innerHTML = '';
            }
        });

        init();
    </script>
</body>
</html>
